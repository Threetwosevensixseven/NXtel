@model NXtelManager.Models.PageEditModel
@{
    var page = Model.Page;
    ViewBag.Title = "Edit Page";
    var btnCaption = "Edit Page";
    string pageID = @page.PageID <= 0 ? "NEW" : @page.PageID.ToString();
    string pageNo = @page.PageID <= 0 ? "" : @page.PageNo.ToString();
    string frame = @page.PageID <= 0 ? "" : @page.Frame;
}
<h2>@ViewBag.Title</h2>
<h3>@ViewBag.Message</h3>
@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()
    <table id="tblEdit" class="edit">
        <tbody>
            <tr>
                <td class="lbl">Page ID:</td>
                <td class="data" colspan="5">@pageID@Html.Hidden("PageID", @page.PageID)</td>
            </tr>
            <tr>
                <td class="lbl">Title:</td>
                <td class="data" colspan="5">@Html.TextBox("Title", page.Title, new { maxlength = 30, style = "width:100%;max-width:initial" })</td>
            </tr>
            <tr>
                <td class="lbl">Page No:</td>
                <td class="data">@Html.TextBox("PageNo", pageNo, new { maxlength = 10 })</td>
            </tr>
            <tr>
                <td class="lbl">Frame:</td>
                <td class="data">@Html.TextBox("Frame", frame, new { maxlength = 1, style = "text-transform:lowercase" })</td>
            </tr>
            <tr>
                <td class="lbl">Box Mode:</td>
                <td class="data">@Html.CheckBox("BoxMode", page.BoxMode)</td>
            </tr>
            <tr>
                <td class="lbl">URL:</td>
                <td class="data">@Html.TextArea("URL", page.URL)</td>
            </tr>
            <tr>
                <td class="lbl" style="vertical-align:top">
                    <button onclick="launchEditor();return false;" class="btn btn-default">@btnCaption</button>
                </td>
                <td class="data">
                    <div id="canvasframePreview">
                        <canvas id="framePreview" width="960" height="1000" style="width: 576px; height: 500px;"></canvas>
                    </div>
                </td>
            </tr>
            <tr>
                <td class="lbl" style="vertical-align:top">Templates:</td>
                <td id="PageTemplates" class="data">
                    @Html.Hidden("SelectedTemplates", page.SelectedTemplates)
                    <table style="display:inline">
                        <tbody id="tbodyPageTemplates">
                            @for (int i = 0; i < page.Templates.Count; i++)
                                {
                                    string id = "trPageTemplate" + (i + 1).ToString();
                                    string tid = page.Templates[i].TemplateID.ToString();
                                    <tr id="@id" + page.Templates[i].TemplateID class="template ordered" data-template-id="@tid">
                                    <td>@Html.Hidden("Templates[" + i + "].TemplateID", page.Templates[i].TemplateID)
                                        @Html.Hidden("Templates[" + i + "].Description", page.Templates[i].Description)
                                        @page.Templates[i].Description</td>
                                    <td><a href="#" class="ordered ordered-btn up" title="Move template up">Up</a></td>
                                    <td><a href="#" class="ordered ordered-btn down" title="Move template down">Down</a></td>
                                    <td><a href="#" class="ordered ordered-btn delete" title="Delete template">Delete</a></td>
                                </tr>
                            }
                        </tbody>
                        <tbody style="display:none">
                            <tr id="trPageTemplateXXX" class="template ordered">
                                <td>@Html.DropDownList("TemplateMasterListXXX", Model.Templates)</td>
                                <td><a href="#" class="ordered ordered-btn up" title="Move template up">Up</a></td>
                                <td><a href="#" class="ordered ordered-btn down" title="Move template down">Down</a></td>
                                <td><a href="#" class="ordered ordered-btn delete" title="Delete template">Delete</a></td>
                            </tr>
                        </tbody>
                    </table>
                    <a href="#" class="ordered ordered-btn add" title="Add template" style="display:inline-block;position:relative;top:-3px">Add</a>
                </td>
            </tr>
        </tbody>
    </table>
    @Html.ValidationSummary(false, "", new { @class = "text-danger" })
    <input type="submit" value="Save" name="action:Save" class="btn btn-primary" />
    <input type="submit" value="Delete" name="action:Delete" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this page?');" />
    @Html.ActionLink("Back to Page List", "Index")
}

@section head {
<link type="text/css" rel="stylesheet" href="~/Content/teletext.css" />
}

@section editor {
@Html.Partial("_Editor")
}

@section Scripts {
<script type="text/javascript" src="~/Scripts/teletext-editor.js"></script>
<script type="text/javascript" src="~/Scripts/editor.js"></script>
<script type="text/javascript">
    var nextTemplateID = 0;

    $("#PageTemplates .ordered-btn.add").click(function (event) {
        event.preventDefault();
        addTemplate(this);
    });

    $("#tbodyPageTemplates .ordered-btn.delete").click(function (event) {
        event.preventDefault();
        deleteTemplate(this);
    });

    $("#tbodyPageTemplates .ordered-btn.up").click(function (event) {
        event.preventDefault();
        moveTemplateUp(this);
    });

    $("#tbodyPageTemplates .ordered-btn.down").click(function (event) {
        event.preventDefault();
        moveTemplateDown(this);
    });

    function getNextTemplateID() {
        var rv = nextTemplateID - 1;
        nextTemplateID = rv;
        return rv.toString();
    }

    jQuery.fn.outerHTML = function (s) {
        return s
            ? this.before(s).remove()
            : jQuery("<div>").append(this.eq(0).clone()).html();
    };

    function addTemplate(btn) {
        var id = getNextTemplateID();
        var html = $("#trPageTemplateXXX").outerHTML().replace(/XXX/g, id);
        $("#tbodyPageTemplates").append(html);
        $("#trPageTemplate" + id + " .ordered-btn.delete").click(function (event) {
            event.preventDefault();
            deleteTemplate(this);
        });
        $("#trPageTemplate" + id + " .ordered-btn.up").click(function (event) {
            event.preventDefault();
            moveTemplateUp(this);
        });
        $("#trPageTemplate" + id + " .ordered-btn.down").click(function (event) {
            event.preventDefault();
            moveTemplateDown(this);
        });
        $("#trPageTemplate" + id + " select").change(function (event) {
            event.preventDefault();
            setSelectedTemplates();
        });
        setSelectedTemplates();
    }

    function deleteTemplate(btn) {
        var row = $(btn).parents("tr.template.ordered");
        $(row.remove());
        setSelectedTemplates();
    }

    function moveTemplateUp(btn) {
        var row = $(btn).parents("tr.template.ordered");
        var first = $("#tbodyPageTemplates tr:first-child")
        if (row !== first)
            $(row).insertBefore(row.prev());
        setSelectedTemplates();
    }

    function moveTemplateDown(btn) {
        var row = $(btn).parents("tr.template.ordered");
        var last = $("#tbodyPageTemplates tr:last-child")
        if (row !== last)
            $(row).insertAfter(row.next());
        setSelectedTemplates();
    }

    function setSelectedTemplates()
    {
        var val = "";
        var join = "";
        $("#tbodyPageTemplates tr").each(function (index, row) {
            var id = $(row).attr("id").replace(/trPageTemplate/g, "") * 1;
            if (id > 0) {
                var id = $(row).data("template-id") * 1;
                val += join + id.toString();
            } else {
                var id = $("#TemplateMasterList" + id.toString()).val();
                if (id > 0)
                    val += join + id.toString();
            }
            join = ",";
        });
        $("#SelectedTemplates").val(val);
    }
    </script>
}
